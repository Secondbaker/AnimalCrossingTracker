<!DOCTYPE html>
<html lang="en">
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Animal Crossing Tracker</title>
	<%= csrf_meta_tags %>
	<%= csp_meta_tag %>

	<link rel="stylesheet" href="https://use.typekit.net/kyh4nqi.css">
	<%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
	<%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
</head>

<body>

<header>
	<% if session[:userinfo] == nil %>
		<%= button_to 'Login', 'auth/auth0', method: :post %>
	<% else %>
		<%= button_to 'Logout', '/logout', method: :get %>
	<% end %>
	<% unless params[:controller] == 'welcome' %>
		<nav>
			<ul class="main-menu">
				<li class="logo"><a href=""><%= image_tag "logo.png" %></a></li>
				<li class="menu"><a href="">Fish</a></li>
				<!--<li class="menu"><a href="">Bugs</a></li>
				<li class="menu"><a href="">Fossils</a></li>-->
				<li class="login"><a href="">
					<% if session[:userinfo] == nil %>
						<%= button_to 'Login', 'auth/auth0', method: :post %>
					<% else %>
						<%= button_to 'Logout', '/logout', method: :get %>
					<% end %>
				</a></li>
			</ul>
		</nav>
	<% end %>
</header>
<%= yield %>

</body>

<script>

/*function navDropdown() {
	document.getElementById("collections-submenu").classList.toggle("show");
}
	
window.onclick = function(event) {
	if (!event.target.matches(".dropdown")) {
		var dropdowns = document.getElementsByClassName("submenu");
		var i;
		for (i = 0; i < dropdowns.length; i++) {
			var openDropdown = dropdowns[i];
			if (openDropdown.classList.contains('show')) {
				openDropdown.classList.remove('show');
			}
		}
	}
}*/
function checkFilters() {
	var filterString = "none";

	var filters = [];

	var filter_checkboxes = $('.filter-checkbox');

	var filter_multi_selects = $('.filter-multi-select');

	$(filter_checkboxes).each(function( index ) {
  		filters.push($(this).find('input:checked').attr('value'));
		
	});

	$(filter_multi_selects).each(function( index ){
		console.log($(this).find('select').val());
		if ($(this).find('select').val().length > 0)
		{
			$(this).find('select').val().forEach(value => console.log(value) );
		}
	});

	console.log(filters);
	return filterString;
}

function countCheckbox() {
	return $('#collection input[type="checkbox"]').length;
}

function countCheckedCheckbox() {
	return $('#collection input[type="checkbox"]:checked').length;
}

function setSortLink() {
	var sort_by = $('#sort_by').find(':selected').val().replace(' ', '%20');

	var link = $('#sort_link').prop('href');
	var link_parts = link.split('/');
	var island_collection_id = link_parts[link_parts.length - 1];
	
	var order = $('#order').find(':selected').val();
	if(order === 'Ascending')
		order = 'asc';
	else if (order === 'Descending')
		order = 'desc';

	var filter = checkFilters();
	var newPath = '/island_collections/' + island_collection_id + '/sort_by/' + sort_by + '/order/' + order + '/filter/' + filter + "/" + island_collection_id;
	
	$('#sort_link').prop('href', newPath);
}

document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();
document.getElementById("count-checkboxes").innerHTML = countCheckbox();

$('.collectible').click(
	function(){
		var checkbox = $(this).find('input[type="checkbox"]');

		if (checkbox[0].checked === false) {
			checkbox[0].checked = true;
		}
		else if (checkbox[0].checked == true) {
			checkbox[0].checked = false;
		}

		document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();

	}
);

function checkboxToggle(){
	var checkbox = $("#modal-checkbox");

	if (checkbox[0].checked === false) {
		checkbox[0].checked = true;
	}
	else if (checkbox[0].checked == true) {
		checkbox[0].checked = false;
	}

	var checkbox = $('#' + checkbox.attr('data_value') + '-complete');

	if (checkbox[0].checked === false) {
		checkbox[0].checked = true;
	}
	else if (checkbox[0].checked == true) {
		checkbox[0].checked = false;
	}
	document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();
}

$('#modal-toggle').click(function(){
	checkboxToggle();
});

$('#modal-checkbox').on('change', function(ev){
	$.ajax({
        type: "PATCH",
        url: '/collectibles/' +  $('#modal-checkbox').attr('data_value') + '/toggle',
        success: function(response) {
		
			var checkbox = $('#' +  $('#modal-checkbox').attr('data_value') + '-complete');

			if (checkbox[0].checked === false) {
				checkbox[0].checked = true;
			}
			else if (checkbox[0].checked == true) {
				checkbox[0].checked = false;
			}

			document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();
        }
	});
});

$('#sort_by').on('change', function(ev) {
	setSortLink();	
});
$('#order').on('change', function(ev) {
	setSortLink();	
});
$('.filter-multi-select').on('change', function(ev) {
	setSortLink();	
});

$('.filter-checkbox').on('change', function(ev) {
	if($(this).find('input').attr('checked'))
	{
		$(this).find('input').removeAttr('checked');
	}
	else
	{
		$(this).find('input').attr('checked', 'checked');
	}
	setSortLink();
});

var btns = $('.modal-btn');

btns.on('click', function(e) {
	e.preventDefault();
	
	var modal = $(".modal");
	$('#modal_contents').replaceWith("<div id='modal_contents'></div>");
  	modal.toggleClass('visible-modal');
});

$('.modal-close').on('click', function(e) {
	$('.modal').removeClass("visible-modal");
});

</script>
</html>