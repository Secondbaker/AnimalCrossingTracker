<!DOCTYPE html>
<html lang="en">
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Animal Crossing Tracker</title>
	<%= csrf_meta_tags %>
	<%= csp_meta_tag %>

	<link rel="stylesheet" href="https://use.typekit.net/kyh4nqi.css">
	<%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
	<%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
</head>

<body>

<header>
	<% if session[:userinfo] == nil %>
		<%= button_to 'Login', 'auth/auth0', method: :post %>
	<% else %>
		<%= button_to 'Logout', '/logout', method: :get %>
	<% end %>
	<% unless params[:controller] == 'welcome' %>
		<nav>
			<ul class="main-menu">
				<li class="logo"><a href=""><%= image_tag "logo.png" %></a></li>
				<li class="menu"><a href="">Fish</a></li>
				<!--<li class="menu"><a href="">Bugs</a></li>
				<li class="menu"><a href="">Fossils</a></li>-->
				<li class="login"><a href="">
					<% if session[:userinfo] == nil %>
						<%= button_to 'Login', 'auth/auth0', method: :post %>
					<% else %>
						<%= button_to 'Logout', '/logout', method: :get %>
					<% end %>
				</a></li>
			</ul>
		</nav>
	<% end %>
</header>
<%= yield %>

</body>

<script>

/*function navDropdown() {
	document.getElementById("collections-submenu").classList.toggle("show");
}
	
window.onclick = function(event) {
	if (!event.target.matches(".dropdown")) {
		var dropdowns = document.getElementsByClassName("submenu");
		var i;
		for (i = 0; i < dropdowns.length; i++) {
			var openDropdown = dropdowns[i];
			if (openDropdown.classList.contains('show')) {
				openDropdown.classList.remove('show');
			}
		}
	}
}*/

function countCheckbox() {
	return $('#collection input[type="checkbox"]').length;
}

function countCheckedCheckbox() {
	return $('#collection input[type="checkbox"]:checked').length;
}

function setSortLink() {
	var sort_by = $('#sort_by').find(':selected').val().replace(' ', '%20');

	var link = $('#sort_link').prop('href');
	var link_parts = link.split('/');
	var island_collection_id = link_parts[link_parts.length - 1];
	
	var order = $('#order').find(':selected').val();
	if(order === 'Ascending')
		order = 'asc';
	else if (order === 'Descending')
		order = 'desc';

	var newPath = '/island_collections/' + island_collection_id + '/sort_by/' + sort_by + '/order/' + order + '/' + island_collection_id;
	
	$('#sort_link').prop('href', newPath);
}

document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();
document.getElementById("count-checkboxes").innerHTML = countCheckbox();

$('.collectible').click(
	function(){
		var checkbox = $(this).find('input[type="checkbox"]');

		if (checkbox[0].checked === false) {
			checkbox[0].checked = true;
		}
		else if (checkbox[0].checked == true) {
			checkbox[0].checked = false;
		}

		document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();

	}
);

function checkboxToggle(){
	var checkbox = $("#modal-checkbox");

	if (checkbox[0].checked === false) {
		checkbox[0].checked = true;
	}
	else if (checkbox[0].checked == true) {
		checkbox[0].checked = false;
	}

	var checkbox = $('#' + checkbox.attr('data-value') + '-complete');

	if (checkbox[0].checked === false) {
		checkbox[0].checked = true;
	}
	else if (checkbox[0].checked == true) {
		checkbox[0].checked = false;
	}
	document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();
}

$('#modal-toggle').click(function(){
	checkboxToggle();
});

$('#modal-checkbox').on('change', function(ev){
	$.ajax({
        type: "PATCH",
        url: '/collectibles/' +  $('#modal-checkbox').attr('data-value') + '/toggle',
        success: function(response) {
		
			var checkbox = $('#' +  $('#modal-checkbox').attr('data-value') + '-complete');

			if (checkbox[0].checked === false) {
				checkbox[0].checked = true;
			}
			else if (checkbox[0].checked == true) {
				checkbox[0].checked = false;
			}

			document.getElementById("count-checked-checkboxes").innerHTML = countCheckedCheckbox();
        }
	});
});

$('#sort_by').on('change', function(ev) {
	setSortLink();	
});
$('#order').on('change', function(ev) {
	setSortLink();	
});

var btns = $('.modal-btn');

function renderFromJSON(){

}

btns.on('click', function(e) {
	e.preventDefault();
	var btnId = this.id;
	btnId = btnId.split("-")[1];

	var modal = $(".modal");

	$.ajax({
        type: "GET",
        url: '/collectibles/' + btnId + '.json',
        success: function(response) {
            var collectible_json = response;
			console.log(collectible_json);
			console.log(collectible_json["name"]);
			console.log($('#modal-collectible-name').text());
			//Set name
			$('#modal-collectible-name').text(collectible_json["name"]);
			//Set thumbnail
			$('#modal-collectible-thumbnail').attr('src', collectible_json["thumbnail"]);
			//Set the checkbox value
			$('#modal-checkbox').attr('value', collectible_json["complete"]);
			$('#modal-checkbox').attr('checked', collectible_json["complete"]);
			$('#modal-checkbox').attr('data-value', collectible_json["id"]);
			//Set the toggle url
			$('#modal-toggle').attr('href', '/collectibles/' + btnId + '/toggle/');
			$('#modal-checkbox-toggle').attr('href','/collectibles/' + btnId + '/toggle/');

			var collectible_attribute_types = $('.modal-collectible-attribute-type')
			var collectible_attribute_values = $('.modal-collectible-attribute-value')

			collectible_json["collectible_attributes"].forEach(collectible_attribute => {
				var attribute_type = $.grep(collectible_attribute_types, function(cat){
					if($(cat).text() == collectible_attribute["collectible_attribute_type"]["name"])
						return cat;
				});

				attribute_type.forEach(type => {
					var value_div = $('.modal-collectible-attribute-value[value=' + $(type).attr('value') + ']');
					console.log(value_div);
					console.log(value_div[0]);
					var value = $(value_div).find('p[class="collectible_attribute_value"]');
					value.text(collectible_attribute["collectible_attribute_value"]["value"]);
				});


			});
        }
	});

  	modal.toggleClass('visible-modal');
});

$('.modal-close').on('click', function(e) {
	$('.modal').removeClass("visible-modal");
});

</script>
</html>